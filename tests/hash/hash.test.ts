import {
  BigNum,
  ConstrPlutusData,
  Costmdls,
  Ed25519KeyHash,
  NativeScript,
  PlutusData,
  PlutusList,
  Redeemers,
  ScriptPubkey,
} from "../../src/generated";
import { hash_plutus_data, hash_script_data } from "../../src/hash";

describe("hash_plutus_data Tests", () => {
  test("Hash of ConstrPlutusData with tag 0 and empty list", () => {
    // Create ConstrPlutusData with tag 0 and empty list
    const tag = BigNum.from_str("0");
    const dataList = PlutusList.new();
    const constrData = ConstrPlutusData.new(tag, dataList);
    const plutusData = PlutusData.new_constr_plutus_data(constrData);

    const hashHex = hash_plutus_data(plutusData).to_hex();

    const expectedHash =
      "923918e403bf43c34b4ef6b48eb2ee04babed17320d8d1b9ff9ad086e86f44ec";

    // Assert that the hashes match
    expect(hashHex).toBe(expectedHash);
  });

  test("Hash of known datum with indefinite arrays", () => {
    // This is a known datum with indefinite arrays and a known expected hash
    const hexData =
      "d8799fd8799f581ca183bf86925f66c579a3745c9517744399679b090927b8f6e2f2e1bb4f616461706541696c656e416d61746fffd8799f581c9a4e855293a0b9af5e50935a331d83e7982ab5b738ea0e6fc0f9e6564e4652414d455f36353030335f4c30ff581cbea1c521df58f4eeef60c647e5ebd88c6039915409f9fd6454a476b9ff";
    const expectedHash =
      "ec3028f46325b983a470893a8bdc1b4a100695b635fb1237d301c3490b23e89b";

    const plutusData = PlutusData.from_hex(hexData);

    const hashHex = hash_plutus_data(plutusData).to_hex();

    expect(hashHex).toBe(expectedHash);
  });

  test("Hash of same datum with definite arrays", () => {
    const hexData =
      "d87983d87982581ca183bf86925f66c579a3745c9517744399679b090927b8f6e2f2e1bb4f616461706541696c656e416d61746fd87982581c9a4e855293a0b9af5e50935a331d83e7982ab5b738ea0e6fc0f9e6564e4652414d455f36353030335f4c30581cbea1c521df58f4eeef60c647e5ebd88c6039915409f9fd6454a476b9";
    const expectedHash =
      "816cdf6d4d8cba3ad0188ca643db95ddf0e03cdfc0e75a9550a72a82cb146222";

    const plutusData = PlutusData.from_hex(hexData);

    const hashHex = hash_plutus_data(plutusData).to_hex();

    expect(hashHex).toBe(expectedHash);
  });
});

describe("hash_script_data Tests", () => {
  test("Known plutus data hash", () => {

    const redeemers = Redeemers.from_hex("a182000182d87980821a006acfc01ab2d05e00");
    const costmdls = Costmdls.from_hex("a10098a61a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0374f693194a1f0a");
    const plist = PlutusList.from_hex("9fd8799fd8799f581ca183bf86925f66c579a3745c9517744399679b090927b8f6e2f2e1bb4f6164617065416d616e734576616e73ffd8799f581c9a4e855293a0b9af5e50935a331d83e7982ab5b738ea0e6fc0f9e6564e4652414d455f38333030325f4c30ff581cbea1c521df58f4eeef60c647e5ebd88c6039915409f9fd6454a476b9ffff");

    const hash = hash_script_data(redeemers, costmdls, plist);

    expect(hash.to_hex()).toBe("e77f547d8249947bf0af31c432fcfff9c1872b2502b3f34d8107002255695e07");
  });

  test("Known plutus data hash 2", () => {

    const redeemers = Redeemers.from_hex("a182000182d87a808219ef741a01160878");
    const costmdls = Costmdls.from_hex("a10098a61a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0374f693194a1f0a");
    const plist = PlutusList.from_hex("9fd8799f581c45f6a506a49a38263c4a8bbb2e1e369dd8732fb1f9a281f3e88383871a03938700581cee8e37676f6ebb8e031dff493f88ff711d24aa68666a09d61f1d3fb34f43727970746f44696e6f3036333039ffff");

    const hash = hash_script_data(redeemers, costmdls, plist);

    expect(hash.to_hex()).toBe("f3ae8e52bff4c7b8d803469ee61eabf37e96e89f8a3bb80115ad068ab5dff598");
  });

  test("Known plutus data hash with no datums", () => {

    const redeemers = Redeemers.from_hex("a182000082d87980821a000cdcf41a0eab3111");
    const costmdls = Costmdls.from_hex("a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a0374f693194a1f0a1a02515e841980b30a");
    const plist = undefined;

    const hash = hash_script_data(redeemers, costmdls, plist);

    expect(hash.to_hex()).toBe("5b235dbfaa999fb3616da9903d9affd09c7f2121c2d50db7ece0a9fb8587a038");
  });

  test("No redeemers", () => {

    const redeemers = Redeemers.new();
    const costmdls = Costmdls.new();
    const plist = PlutusList.from_hex("9fd8799fd8799fd8799f581c7fbb4763847b9ec49a132d5359bd86aaecde9275a03aef294ffb79d0ffd8799fd8799fd8799f581cfa34f3b651ecb6a75834c80dc1fd162feb1d1b4cdcef0d065a5785aaffffffffd8799fd8799f581c7fbb4763847b9ec49a132d5359bd86aaecde9275a03aef294ffb79d0ffd8799fd8799fd8799f581cfa34f3b651ecb6a75834c80dc1fd162feb1d1b4cdcef0d065a5785aaffffffffd87a80d8799fd8799f4040ff1a059eb214ff1a001e84801a001e8480ffff");

    const hash = hash_script_data(redeemers, costmdls, plist);

    expect(hash.to_hex()).toBe("fd53a28a846ae6ccf8b221d03d4af122b0b3c442089c05b87e3d86c6792b3ef0");
  });

});

describe("Native scripts hash Tests", () => {
  test("Test 1", () => {

    const keyhash = Ed25519KeyHash.from_bytes(new Uint8Array([
      143, 180, 186, 93, 223, 42, 243, 7, 81, 98, 86, 125, 97, 69, 110, 52, 130, 243, 244, 98,
      246, 13, 33, 212, 128, 168, 136, 40,
    ]));

    expect(keyhash.to_hex()).toBe("8fb4ba5ddf2af3075162567d61456e3482f3f462f60d21d480a88828");

    const script = NativeScript.new_script_pubkey(ScriptPubkey.new(keyhash));

    expect(script.hash().to_hex()).toBe("187b8d3ddcb24013097c003da0b8d8f7ddcf937119d8f59dccd05a0f");
  });

  test("Test 2", () => {
    const script = NativeScript.from_hex("8202838200581c01efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee1648200581c02efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee1648200581c03efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee164")

    expect(script.hash().to_hex()).toBe("64f4c8d2f8fb87aab8dadd5c850920e97b1dc23cb735095832df0259");
  });

  test("Test 3", () => {
    const script = NativeScript.from_hex("82028383030182820418848200581c03efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee164820182820518848200581c01efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee1648202838200581c01efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee1648200581c02efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee1648200581c03efb5788e8713c844dfd32b2e91de1e309fefffd555f827cc9ee164")

    expect(script.hash().to_hex()).toBe("44b044989c15957d565bb7242f7e3124c38b0cbaac1e53ef028c860f");
  });
});
